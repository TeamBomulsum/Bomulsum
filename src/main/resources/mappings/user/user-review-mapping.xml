<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="userReviewDAO">

	<resultMap type="com.web.bomulsum.user.review.repository.UserReviewVO" id="reviewListMap">
		<result column="member_name" property="memberName"/>
		<result column="member_profile" property="memberProfile"/>
		
		<result column="buy_art_code_seq" property="buyArtCodeSeq"/>
		<result column="B_ART_CODE_SEQ" property="bArtCodeSeq"/>
		<result column="B_ART_NAME" property="bArtName"/>
		<result column="B_WRITER_CODE_SEQ" property="bWriterCodeSeq"/>
		<result column="B_ART_OPTION_CATEGORY" property="bArtOptionCategory"/>
		<result column="B_ART_OPTION_NAME" property="bArtOptionName"/>
		<result column="B_ART_OPTION_PRICE" property="bArtOptionPrice"/>
		<result column="B_ART_OPTION_COUNT" property="bArtOptionCount"/>
		<result column="B_ART_REVIEW_STATUS" property="bArtReviewStatus"/>
		<result column="B_ART_REVIEW" property="bArtReview"/>
		
		<result column="art_photo" property="artPhoto"/>
		<result column="art_description" property="artDescription"/>
		
		<result column="writer_name" property="writerName"/>
		
		<result column="order_date" property="orderDate"/>
		
		<result column="review_code_seq" property="reviewCodeSeq" />
		<result column="review_date" property="reviewDate" />
		<result column="review_star" property="reviewStar" />
		<result column="review_comment" property="reviewComment" />
		<result column="art_name" property="artName" />
		<result column="writer_code_seq" property="writerCodeSeq" />
		<result column="member_name" property="memberName" />
		<result column="member_profile" property="memberProfile" />
		
	</resultMap>

	<!-- 구매후기 쓸 수 있는 구매 상품 목록 불러오기 -->
	<select id="reviewList" parameterType="String" resultMap="reviewListMap">
		SELECT ROWNUM AS RNUM, X.*
			FROM (
				SELECT
					a.buy_art_code_seq, a.member_code_seq, a.B_ART_CODE_SEQ,
					a.B_ART_NAME, a.B_WRITER_CODE_SEQ, a.B_ART_OPTION_CATEGORY,
					a.B_ART_OPTION_NAME, a.B_ART_OPTION_PRICE, a.B_ART_OPTION_COUNT,
					a.B_ART_REVIEW_STATUS, a.B_ART_REVIEW, b.art_photo, b.art_description,
					c.writer_name, d.order_date
				FROM buy_art_tb a
				LEFT OUTER JOIN
					art_tb b ON a.b_art_code_seq = b.art_code_seq
				LEFT OUTER JOIN
					writer_tb c ON b.writer_code_seq = c.writer_code_seq
				LEFT OUTER JOIN
					order_tb d ON  a.order_code_seq = d.order_code_seq
				WHERE a.b_art_review_status = 'N' AND a.member_code_seq = #{member}
				ORDER BY d.order_date DESC
				) X
	</select>
	
	<!-- 작성한 구매후기 목록 불러오기 -->
	<!-- 작품 테이블에서 작품 이름, 작품 사진, 맴버 테이블에서 맴버 사진, 맴버 이름, 구매후기 테이블에서 별점, 날짜, 내용 불러와야됨 -->
	<select id="reviewedList" parameterType="String" resultMap="reviewListMap">
		SELECT ROWNUM AS RNUM, X.*
			FROM (
				SELECT
					a.review_code_seq, a.review_date, a.review_star, a.review_comment,
					b.art_photo, b.art_name, b.writer_code_seq,
					c.member_name, c.member_profile,
					d.b_art_review_status, d.b_art_review
				FROM
					review_tb a
				LEFT OUTER JOIN
					art_tb b ON a.art_code_seq = b.art_code_seq
				LEFT OUTER JOIN
					member_tb c ON a.member_code_seq = c.member_code_seq
				LEFT OUTER JOIN
					buy_art_tb d ON a.buy_art_code_seq = d.buy_art_code_seq
				WHERE
					a.member_code_seq = #{member}
				ORDER BY a.review_date DESC
				) X
	</select>

	<!-- 구매후기 등록 -->
	<insert id="reviewReg" parameterType="com.web.bomulsum.user.review.repository.UserReviewVO">
		INSERT INTO review_tb
		(
			review_code_seq,
			buy_art_code_seq,
			member_code_seq,
			art_code_seq,
			review_comment,
            review_star,
            review_photo
		)
		VALUES
		(
			'review_code_seq' || TO_CHAR(review_sq.nextval),
			#{buyArtCodeSeq},
			#{memberCodeSeq},
			#{artCodeSeq},
			#{reviewComment},
            #{reviewStar},
            #{reviewPhoto}
		)
	</insert>
	<!-- 구매후기 수정 -->
	<update id="updateReview" parameterType="com.web.bomulsum.user.review.repository.UserReviewVO">
		UPDATE
			review_tb
		SET
			review_comment = #{reviewComment},
			review_star = #{reviewStar},
			review_photo = #{reviewPhoto}
	</update>
	
	
	<!-- 구매작품 테이블 후기 상태 수정 -->
	<update id="updateBuyArtTb" parameterType="com.web.bomulsum.user.review.repository.UserReviewVO">
		UPDATE
			buy_art_tb
		SET
			b_art_review_status = 'Y'
		WHERE
			buy_art_code_seq = #{buyArtCodeSeq}
	</update>
	<update id="updateBuyArtTb2" parameterType="com.web.bomulsum.user.review.repository.UserReviewVO">
		UPDATE
			buy_art_tb
		SET
			b_art_review = 'Y'
		WHERE
			buy_art_code_seq = #{buyArtCodeSeq}
	</update>

	<!-- 작가 한테 알람 쏴주기 -->
	<insert id="insertAlarmTb" parameterType="com.web.bomulsum.user.review.repository.UserReviewVO">
		INSERT INTO alarm_tb
		(
			alarm_seq,
			sender_code,
			recipient_code,
			alarm_title,
			alarm_content
		)
		VALUES
		(
			'alarm_seq' || TO_CHAR(alarm_sq.nextval),
			#{writerCodeSeq},
			#{memberCodeSeq},
			'구매후기',
			#{alarmContent}
		)
	</insert>

	<!-- 구매목록 불러오기 -->
 	<!-- <select id="" parameterType="String" resultMap="">
 		SELECT * FROM buy_art_tb
 		WHERE 
 			(member_code_seq = #{memberCodeSeq})
 			AND (b_art_review = 'N')
	</select>
 -->
	<!-- 구매후기 등록하기 -->
	<!-- <insert id="" parameterType="">
	</insert> -->

</mapper>