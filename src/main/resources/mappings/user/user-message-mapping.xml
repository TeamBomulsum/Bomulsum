<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="NodeDbDAO">

	<resultMap type="com.web.bomulsum.user.message.repository.NodeDbVO" id="nodeDbVo">
		<result property="messageSeq" column="message_seq"/>
		<result property="memberCodeSeq" column="member_code_seq"/>
		<result property="writerCodeSeq" column="writer_code_seq"/>
		<result property="messageContent" column="message_content"/>
		<result property="messageTime" column="message_time"/>
		<result property="messageRead" column="message_read"/>
	</resultMap>
	
	<resultMap type="com.web.bomulsum.user.message.repository.UserChatRoomVO" id="chatVo">
		<result property="writerCode" column="writer_code_seq"/>
		<result property="writerName" column="writer_name"/>
		<result property="writerImg" column="writer_profile_img"/>
		<result property="writerBrandName" column="writer_brand_name"/>
	</resultMap>

	
	<select id="getMessage" resultMap="nodeDbVo">
		SELECT * FROM message_tb
	</select>
	
	<select id="getUserCodes" resultType="String">
		SELECT member_code_seq
		FROM member_tb
	</select>
	
	<select id="getChatroom" parameterType="String" resultMap="chatVo">
		SELECT 
			w.writer_code_seq, 
			w.writer_name, 
			w.writer_brand_name,
			w.writer_profile_img
		FROM 
			writer_tb w
		INNER JOIN 
			(chatroom_tb c)
		ON 
			w.writer_code_seq = c.writer_code_seq
		WHERE 
			(
				c.member_code_seq = #{userCode}
				AND
				c.chatroom_in_member = 'Y'
			)
		ORDER BY 
			c.chatroom_date
	</select>
	
	<select id="testGetWriter" resultMap="chatVo">
		SELECT
			writer_code_seq, writer_name, writer_profile_img, writer_brand_name
		FROM
			writer_tb
	</select>
	
	<select id="insertChatRoomBefore" parameterType="com.web.bomulsum.user.message.repository.UserInsertChatVo"
		resultType="String">
		SELECT
			chatroom_in_member
		FROM
			chatroom_tb
		WHERE
			(
				member_code_seq=#{memberCode}
				AND
				writer_code_seq=#{writerCode}
			)
	</select>
	
	<update id="updateChatRoom" parameterType="com.web.bomulsum.user.message.repository.UserInsertChatVo">
		UPDATE
			chatroom_tb
		SET
			chatroom_in_member='Y'
		WHERE
			(
				member_code_seq=#{memberCode}
				AND
				writer_code_seq=#{writerCode}
			)
	</update>
	
	<insert id="insertChatRoom" parameterType="com.web.bomulsum.user.message.repository.UserInsertChatVo">
		INSERT INTO
		chatroom_tb
		(
			chatroom_sq,
			member_code_seq,
			writer_code_seq,
			chatroom_in_member
		)
		VALUES
		(
			'chatroom_sq' || TO_CHAR(chatroom_sq.nextval), 
			#{memberCode}, 
			#{writerCode},
			'Y'
		)
	</insert>
	
	<update id="delChatRoom" parameterType="java.util.List">
		
		UPDATE
			chatroom_tb
		SET
			chatroom_in_member='N'
		<where>
			<foreach collection="list" item="item" open="" close="" separator="OR">
				(
					member_code_seq=#{item.memberCode} 
				AND 
					writer_code_seq=#{item.writerCode}
				)
			</foreach>
		</where>
	</update>
	
	
</mapper>
